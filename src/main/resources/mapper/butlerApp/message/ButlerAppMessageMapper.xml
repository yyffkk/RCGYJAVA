<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.api.butlerApp.dao.message.ButlerAppMessageDao">
    <select id="findSysNoReadNumById" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        select count(*) from butler_sys_message where receiver_account = #{id} and send_status = 1
    </select>

    <select id="findFirstTypeById" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        select type from butler_sys_message where receiver_account = #{id} order by send_date DESC limit 1
    </select>

    <select id="findCommentNoReadNumById" parameterType="java.lang.Integer" resultType="java.lang.Integer">
        select count(*) from butler_comment_message where receiver_account = #{id} and send_status = 1
    </select>

    <select id="sysMessageList" parameterType="java.lang.Integer" resultType="com.api.vo.butlerApp.ButlerSysMessageVo">
        select id,type,relation_id,send_date from butler_sys_message where receiver_account = #{id}
    </select>

    <select id="sysCommentMessageList" parameterType="java.lang.Integer" resultType="com.api.vo.butlerApp.ButlerCommentMessageVo">
        select id,type,relation_id,send_date from butler_comment_message where receiver_account = #{id}
    </select>
    <insert id="insert" parameterType="com.api.model.butlerApp.ButlerAppCommentMessage">
        insert into butler_comment_message(
            type,
            relation_id,
            receiver_account,
            send_status,
            send_date
        )values (
            #{type},
            #{relationId},
            #{receiverAccount},
            #{sendStatus},
            #{sendDate}
        )
    </insert>

    <insert id="insertSysMessage" parameterType="com.api.model.butlerApp.ButlerAppSysMessage">
        insert into butler_sys_message(
            type,
            relation_id,
            receiver_account,
            send_status,
            send_date
        )values (
            #{type},
            #{relationId},
            #{receiverAccount},
            #{sendStatus},
            #{sendDate}
        )
    </insert>

    <select id="findRepairByRepairId" parameterType="java.lang.Integer" resultType="com.api.vo.butlerApp.ButlerRepairMessageVo">
        select srr.id,srr.tel,srr.type,ur.name from sys_report_repair as srr,user_resident as ur
        where srr.repairman = ur.id and srr.id = #{repairId}
    </select>

    <select id="findCommentByDispatchId" parameterType="java.lang.Integer" resultType="com.api.vo.butlerApp.ButlerRepairCommentMesVo">
        select sdl.id,ur.name,sdl.evaluation_level as level from sys_report_repair as srr,user_resident as ur,sys_dispatch_list as sdl
        where srr.repairman = ur.id and srr.dispatch_list_id = sdl.id and sdl.id = #{dispatchId}
    </select>
    <select id="findFirstSysDateById" parameterType="java.lang.Integer" resultType="java.util.Date">
        select send_date from butler_sys_message where receiver_account = #{id} order by send_date DESC limit 1
    </select>
    <select id="findFirstCommentDateById" parameterType="java.lang.Integer" resultType="java.util.Date">
        select send_date from butler_comment_message where receiver_account = #{id} order by send_date DESC limit 1
    </select>

    <update id="allReadSys" parameterType="java.lang.Integer">
        update butler_sys_message
        set send_status = 3
        where receiver_account = #{id}
    </update>
    <update id="allReadComment" parameterType="java.lang.Integer">
        update butler_comment_message
        set send_status = 3
        where receiver_account = #{id}
    </update>

</mapper>